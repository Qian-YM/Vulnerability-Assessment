package main
import (
	"fmt"
)

func fileCheck() {
    printMsg("## 文件检查")

    printMsg("系统文件修改时间")
    files := []string{
        "/sbin/ifconfig",
        "/bin/ls",
        "/bin/login",
        "/bin/netstat",
        "/bin/top",
        "/bin/ps",
        "/bin/find",
        "/bin/grep",
        "/etc/passwd",
        "/etc/shadow",
        "/usr/bin/curl",
        "/usr/bin/wget",
        "/root/.ssh/authorized_keys",
    }

    for _, file := range files {
        output := getCommandOutput("bash", "-c", fmt.Sprintf("stat %s | grep -P -o '(?<=Modify: )[\\d-\\s:]+'", file))
        printMsg(fmt.Sprintf("文件：%s\t\t\t修改日期：%s", file, output))
    }

    printMsg("### /tmp")
    printCode(getCommandOutput("bash", "-c", "ls /tmp /var/tmp /dev/shm -alht"))

    printMsg("### SUID")
    printCode(getCommandOutput("bash", "-c", "find / ! -path \"/proc/*\" -perm -004000 -type f | egrep -v 'snap|docker|pam_timestamp_check|unix_chkpwd|ping|mount|su|pt_chown|ssh-keysign|at|passwd|chsh|crontab|chfn|usernetctl|staprun|newgrp|chage|dhcp|helper|pkexec|top|Xorg|nvidia-modprobe|quota|login|security_authtrampoline|authopen|traceroute6|traceroute|ps'"))

    printMsg("### lsof +L1")
    printCode(getCommandOutput("bash", "-c", "lsof +L1"))
    
    printMsg("### 近七天文件改动 mtime")
    printCode(getCommandOutput("bash", "-c", "find /etc /bin /lib /sbin /dev /root/ /home /tmp /var /usr ! -path \"/var/log*\" ! -path \"/var/spool/exim4*\" ! -path \"/var/backups*\" -mtime -7 -type f | egrep -v '\\.log|cache|vim|/share/|/lib/|.zsh|.gem|\\.git|LICENSE|README|/_\\w+\\.\\w+|\\blogs\\b|elasticsearch|nohup|i18n' | xargs -i{} ls -alh {}"))

    printMsg("### 近七天文件改动 ctime")
    printCode(getCommandOutput("bash", "-c", "find /etc /bin /lib /sbin /dev /root/ /home /tmp /var /usr ! -path \"/var/log*\" ! -path \"/var/spool/exim4*\" ! -path \"/var/backups*\" -ctime -7 -type f | egrep -v '\\.log|cache|vim|/share/|/lib/|.zsh|.gem|\\.git|LICENSE|README|/_\\w+\\.\\w+|\\blogs\\b|elasticsearch|nohup|i18n' | xargs -i{} ls -alh {}"))

    printMsg("### 大文件>200mb")
    printCode(getCommandOutput("bash", "-c", "find / ! -path \"/proc/*\" ! -path \"/sys/*\" ! -path \"/run/*\" ! -path \"/boot/*\" -size +200M -exec ls -alht {} + 2>/dev/null | grep -P '\\.gif|\\.jpeg|\\.jpg|\\.png|\\.zip|\\.tar.gz|\\.tgz|\\.7z|\\.log|\\.xz|\\.rar|\\.bak|\\.old|\\.sql|\\.1|\\.txt|\\.tar|\\.db|/\\w+$' | egrep -v 'ib_logfile|ibd|mysql-bin|mysql-slow|ibdata1|overlay2'"))

    printMsg("### 敏感文件")
    printCode(getCommandOutput("bash", "-c", "find / ! -path \"/lib/modules*\" ! -path \"/usr/src*\" ! -path \"/snap*\" ! -path \"/usr/include/*\" -regextype posix-extended -regex '.*sqlmap|.*msfconsole|.*\\bncat|.*\\bnmap|.*nikto|.*ettercap|.*tunnel\\.(php|jsp|asp|py)|.*/nc\\b|.*socks.(php|jsp|asp|py)|.*proxy.(php|jsp|asp|py)|.*brook.*|.*frps|.*frpc|.*aircrack|.*hydra|.*miner|.*/ew$' -type f | egrep -v '/lib/python' | xargs -i{} ls -alh {}"))

    printMsg("### 可疑黑客文件")
    printCode(getCommandOutput("bash", "-c", "find /root /home /opt /tmp /var/ /dev -regextype posix-extended -regex '.*wget|.*curl|.*openssl|.*mysql' -type f 2>/dev/null | xargs -i{} ls -alh {} | egrep -v '/pkgs/|/envs/|overlay2'"))
}